<html>
   <head>

      <style lang="css">
         body
         {
            font-family: Segoe UI,Tahoma,Arial,Verdana,sans-serif;
            color: #333;
         }
      </style>

      <script type="text/javascript">

         /// CONFIGURATION //////////////////////////////////

         // edit this for where you run the fuzzing server
         var fuzzing_server = "127.0.0.1:9000";

         // edit this for an identification of agent/testrun or leave null
         // to try autodetection
         var agent = null;

         // specify first/last test case you want to run
         var startCaseId = 1;
         var endCaseId = 50;

         /// CONFIGURATION END //////////////////////////////

         var webSocket = null;
         var currentCaseId = null;

         function startTestRun()
         {
               if (agent == null)
               {
                  ua = navigator.userAgent;
                  if (ua.indexOf("Chrome") > -1)
                  {
                     i = ua.indexOf("Chrome");
                     j = ua.indexOf(" ", i);
                     agent = ua.slice(i, j);
                     updateStatus("Detected user agent " + agent + ".");
                  }
                  else if (ua.indexOf("Firefox") > -1)
                  {
                     i = ua.indexOf("Firefox");
                     j = ua.indexOf(" ", i);
                     s1 = ua.slice(i, j);
                     i = ua.indexOf("Gecko/");
                     j = ua.indexOf(" ", i);
                     s2 = ua.slice(i + "Gecko/".length, j);
                     agent = s1 + "(" + s2 + ")";
                     updateStatus("Detected user agent " + agent + ".");
                  }
                  else
                  {
                     agent = "unknown";
                     updateStatus("Could not detect user agent .. will use '" + agent + "'.");
                  }
               }

               updateStatus("Running test suite for test cases " + startCaseId + " - " + endCaseId + " ..");
               document.getElementById('resultlink').innerHTML = '';
               currentCaseId = startCaseId;
               runNextCase();
         }

         function updateStatus(msg)
         {
            console.log(msg);
            document.getElementById('statusline').innerHTML = msg;
         }

         function openWebSocket(ws_uri)
         {
            try
            {
               webSocket = new WebSocket(ws_uri);
            }
            catch (e)
            {
               // Firefox 7/8 currently prefixes the object
               webSocket = new MozWebSocket(ws_uri);
            }
            return webSocket;
         }

         function updateReports()
         {
            var ws_uri = "ws://" + fuzzing_server + "/updateReports?agent=" + agent;

            webSocket = openWebSocket(ws_uri);

            webSocket.onopen =
               function(e)
               {
                  updateStatus("Updating reports ..");
               }

            webSocket.onclose =
               function(e)
               {
                  webSocket = null;
                  updateStatus("Reports updated.");
                  updateStatus("Test suite finished!");

                  document.getElementById('resultlink').innerHTML = '<a href="../reports/index.html">Check test report</a>';
               }
         }

         function runNextCase()
         {
            var ws_uri = "ws://" + fuzzing_server + "/runCase?case=" + currentCaseId + "&agent=" + agent;

            webSocket = openWebSocket(ws_uri);

            webSocket.onopen =
               function(e)
               {
                  updateStatus("Executing test case " + currentCaseId + "/" + endCaseId);
               }

            webSocket.onclose =
               function(e)
               {
                  webSocket = null;

                  currentCaseId = currentCaseId + 1;
                  if (currentCaseId <= endCaseId)
                  {
                     runNextCase();
                  }
                  else
                  {
                     updateStatus("All test cases executed.");
                     updateReports();
                  }
               }

            webSocket.onmessage =
               function(e)
               {
                  webSocket.send(e.data);
               }
         }

      </script>
   </head>

   <body>
      <h1>WebSockets Protocol Compliance Test</h1>
      <p><button onclick='startTestRun();'>Start Test Run</button></p>
      <p id="statusline"></p>
      <p id="resultlink"></p>
   </body>
</html>
